name: Smoke Test Daily (-s)

on:
  schedule:
    - cron: '0 20 * * 1-5' # 03:00h every night UTC+7
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  chrome-ubuntu:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Checkout WDIO repository
      uses: actions/checkout@v4
      with:
        repository: ${{ secrets.WDIO_REPOS }}
        token: ${{ secrets.WDIO_ACCESS_TOKEN }}
        ref: master
        path: wdio

    - name: Free disk space
      run: |
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo apt-get clean
        df -h    

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: yarn
        cache-dependency-path: wdio/yarn.lock

    - name: Install dependencies
      run: yarn install --frozen-lockfile
      working-directory: wdio

    - name: Run WebDriverIO Tests
      id: wdio
      run: |
        cd wdio
        yarn test:local --suite="Smoke Test" \
          2>&1 | tee ../specs-reporter.log
      env:
        CAPABILITIES: chrome
        MAX_INSTANCES: 2
        R360_DASHBOARD_URL: ${{ secrets.R360_DASHBOARD_URL_S }}

    - name: WDIO Test Checker
      if: always()
      run: |
        LOG="specs-reporter.log"

        [ ! -f "$LOG" ] && exit 0

        LINE=$(grep "Spec Files:" "$LOG" | tail -1 || true)
        [ -z "$LINE" ] && exit 0

        FAILED=$(echo "$LINE" | grep -oP '\d+(?=\s+failed)' || true)
        FAILED=${FAILED:-0}

        [ "$FAILED" -gt 0 ] && exit 1

    - name: Upload spec reporter log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: specs-reporter-log
        path: specs-reporter.log
        retention-days: 7

    - name: Generate Allure Report
      if: always()
      uses: simple-elf/allure-report-action@v1.13
      with:
        allure_results: wdio/reports
        allure_report: wdio/allure-report
        allure_history: wdio/allure-history

    - name: Prepare deploy folder
      if: always()
      run: |
        mkdir -p deploy
        cp -r wdio/allure-report/* deploy/

    - name: Upload Allure HTML
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: reports-html
        path: wdio/allure-report/
        retention-days: 7

    - name: Upload Allure raw results
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: reports-allure
        path: wdio/reports/
        retention-days: 7

    - name: Create firebase config
      if: always()
      run: |
        echo '{
          "hosting": {
            "public": "deploy",
            "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
          }
        }' > firebase.json

        echo '{
          "projects": {
            "default": "record360-report"
          }
        }' > .firebaserc

    - name: Set up Firebase credentials
      if: always()
      run: echo '${{ secrets.CHINH_FIREBASE_SERVICE_ACCOUNT }}' > $GITHUB_WORKSPACE/service-account.json

    - name: Deploy Allure Report to Firebase Hosting
      if: always()
      uses: w9jds/firebase-action@v13.27.0
      with:
        args: deploy --only hosting --project record360-report
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service-account.json

    - name: Parse Spec Reporter Result
      if: always()
      run: |
        LOG=specs-reporter.log

        if ! grep -q "Spec Files:" "$LOG"; then
          echo "Spec summary not found!"
          echo "TOTAL=0" >> $GITHUB_ENV
          echo "PASSED=0" >> $GITHUB_ENV
          echo "FAILED=0" >> $GITHUB_ENV
          echo "SKIPPED=0" >> $GITHUB_ENV
          echo "RETRIES=0" >> $GITHUB_ENV
          echo "DURATION=00:00:00" >> $GITHUB_ENV
          exit 0
        fi

        LINE=$(grep "Spec Files:" "$LOG" | tail -1)

        PASSED=$(echo "$LINE" | grep -oP '\d+(?=\s+passed)' || echo 0)
        RETRIES=$(echo "$LINE" | grep -oP '\d+(?=\s+retries)' || echo 0)
        FAILED=$(echo "$LINE" | grep -oP '\d+(?=\s+failed)' || echo 0)
        SKIPPED=$(echo "$LINE" | grep -oP '\d+(?=\s+skipped)' || echo 0)
        TOTAL=$(echo "$LINE" | grep -oP '\d+(?=\s+total)' || echo 0)
        DURATION=$(echo "$LINE" | grep -oP '\d{2}:\d{2}:\d{2}' || echo "00:00:00")

        PASS_RATE=$(( PASSED * 100 / (TOTAL - SKIPPED)))

        echo "TOTAL=$TOTAL" >> $GITHUB_ENV
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
        echo "RETRIES=$RETRIES" >> $GITHUB_ENV
        echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV
        echo "DURATION=$DURATION" >> $GITHUB_ENV

    - name: Notify Google Chat
      if: always()
      env:
        TZ: Asia/Ho_Chi_Minh
      run: |
        STATUS="PASSED"
        STATUS_COLOR="#0F9D58"
        STATUS_ICON="‚úÖ"

        if [ "${{ job.status }}" = "cancelled" ]; then
          STATUS="CANCELLED"
          STATUS_COLOR="#F4B400"
          STATUS_ICON="üü°"
        elif [ "${{ job.status }}" != "success" ]; then
          STATUS="FAILED"
          STATUS_COLOR="#DB4437"
          STATUS_ICON="‚ùå"
        fi

        export STATUS STATUS_COLOR STATUS_ICON
        export DATE_TIME="$(date '+%d/%m/%Y %H:%M:%S')"
        export REPORT_URL="https://record360-report.web.app"

        envsubst < .github/googleChat/dashboard-card.json > payload.json

        curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK }}" \
          -H "Content-Type: application/json" \
          -d @payload.json